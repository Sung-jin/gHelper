name: Build PacketAnalyzer EXE

on:
  workflow_dispatch: # 수동으로 빌드 실행

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller requests scapy

      - name: Inject Secrets into Config
        shell: pwsh
        run: |
          # analyzer.py에 설정된 기본 웹훅 URL을 GitHub Secret 값으로 교체합니다.
          $codeFile = "engine/tools/analyzer.py"
          $webhook = "${{ secrets.DISCORD_WEBHOOK_ETERNAL }}"
          
          if ([string]::IsNullOrEmpty($webhook)) {
              Write-Error "GitHub Secrets에 DISCORD_WEBHOOK_ETERNAL이 설정되지 않았습니다!"
              exit 1
          }
          
          # 코드 내의 DEFAULT_WEBHOOK_URL 변수 라인을 Secret 값으로 치환
          $content = Get-Content $codeFile -Raw
          $newContent = $content -replace 'DEFAULT_WEBHOOK_URL\s*=\s*"[^"]*"', "DEFAULT_WEBHOOK_URL = `"$webhook`""
          $newContent | Set-Content $codeFile -NoNewline
          
          Write-Host "Discord Webhook URL 주입 완료."

      - name: Build EXE with PyInstaller
        shell: pwsh
        run: |
          # 1. --onefile: 모든 모듈을 하나로 합침
          # 2. --uac-admin: 관리자 권한 요청 (스니핑 필수)
          # 3. --paths: recording.py, utils.py가 있는 경로 추가
          # 4. 외부 수정을 위해 --add-data는 제외함
          
          pyinstaller --onefile `
                      --uac-admin `
                      --name "PacketAnalyzer" `
                      --clean `
                      --paths "engine/tools" `
                      engine/tools/analyzer.py

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PacketAnalyzer-Release-Package
          # 실행 파일과 수동 수정용 mapping.json을 함께 업로드
          path: |
            dist/PacketAnalyzer.exe
            engine/tools/mapping.json