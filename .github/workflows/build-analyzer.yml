name: Build PacketAnalyzer EXE

on:
  workflow_dispatch: # 수동으로 빌드 실행

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller requests scapy
          # 만약 별도의 requirements 파일이 있다면 아래 주석을 해제하세요.
          # pip install -r engine/tools/requirements.txt
          # pip install -r engine/requirements.txt

      - name: Inject Secrets and Prepare Files
        shell: pwsh
        run: |
          $codeFile = "engine/tools/analyzer.py"
          $webhook = "${{ secrets.DISCORD_WEBHOOK_ETERNAL }}"
          
          # URL이 비어있는지 확인
          if ([string]::IsNullOrEmpty($webhook)) {
              Write-Error "DISCORD_WEBHOOK_ETERNAL secret is missing!"
          }

          # 1. 정확하게 문자열 치환 (이스케이프 처리 포함)
          $content = Get-Content $codeFile -Raw
          $content = $content -replace 'YOUR_DISCORD_WEBHOOK_URL', $webhook
          $content | Set-Content $codeFile -NoNewline
          
          # 2. mapping.json 파일이 없으면 기본 빈 파일 생성 (빌드 에러 방지)
          if (!(Test-Path "engine/tools/mapping.json")) {
              '{"83a0": {"type": "습격 5분 전", "locations": {}}, "8380": {"type": "습격 1분 전", "locations": {}}, "f180": {"type": "습격 입장 가능", "locations": {}}}' | Out-File -FilePath "engine/tools/mapping.json" -Encoding utf8
          }

      - name: Build EXE with PyInstaller
        shell: pwsh
        run: |
          # --add-data "소스경로;대상경로" (Windows는 세미콜론 사용)
          # --uac-admin: 실행 시 관리자 권한 요청 (패킷 스니핑에 필수)
          pyinstaller --onefile `
                      --uac-admin `
                      --name "PacketAnalyzer" `
                      --add-data "engine/tools/mapping.json;." `
                      engine/tools/analyzer.py

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PacketAnalyzer-Windows
          path: dist/PacketAnalyzer.exe
